<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Location</title>
    <link href="styles.css" rel="stylesheet">
    <style>
        #map-container {
            position: relative;
            width: 500px; /* adjust as needed */
            height: 500px; /* adjust as needed */
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Get Location</h1>
        <p>Tap the button below to get the location</p>
        <button class="get-location-btn" onclick="collectAndMatchData()">Get Location</button>
        <div id="output"></div>
        <div id="map-container">
            <img id="map" src="Floor Plan 1000x1000 px.jpg" alt="Map">
            <div id="marker"></div>
        </div>
    </div>

    <script>
        function collectAndMatchData() {
            // Collect WLAN and Cellular signal strengths
            var wlanStrength = getWLANSignalStrength();
            var cellularStrength = getCellularSignalStrength();

            // Fetch the pre-stored values from the table
            fetch('https://sheetdb.io/api/v1/w3rcsxtqatd69')
                .then(response => response.json())
                .then(data => {
                    // Perform interpolation
                    var interpolatedLocation = interpolateLocation(data, wlanStrength, cellularStrength);

                    // Output the collected and matched values
                    var output = document.getElementById('output');
                    output.innerHTML = "<p>Latitude: " + interpolatedLocation.latitude.toFixed(6) + "</p>" +
                                       "<p>Longitude: " + interpolatedLocation.longitude.toFixed(6) + "</p>" +
                                       "<p>WLAN Strength: " + wlanStrength + "</p>" +
                                       "<p>Cellular Strength: " + cellularStrength + "</p>";

                    // Update the marker position
                    var marker = document.getElementById('marker');
                    var map = document.getElementById('map');
                    var markerPositionX = interpolatedLocation.longitude * (map.width / 10);
                    var markerPositionY = map.height - (interpolatedLocation.latitude * (map.height / 10));
                    marker.style.left = markerPositionX + 'px';
                    marker.style.top = markerPositionY + 'px';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('An error occurred while fetching data. Please try again later.');
                });
        }

        function interpolateLocation(data, wlanStrength, cellularStrength) {
            var totalWeight = 0;
            var weightedLatSum = 0;
            var weightedLngSum = 0;

            data.forEach(point => {
                var wlanDifference = Math.abs(wlanStrength - point.wlan_strength);
                var cellularDifference = Math.abs(cellularStrength - point.cellular_strength);
                var distance = Math.sqrt(Math.pow(wlanDifference, 2) + Math.pow(cellularDifference, 2));
                var weight = 1 / (distance + 0.0001); // Avoid division by zero

                totalWeight += weight;
                weightedLatSum += point.latitude * weight;
                weightedLngSum += point.longitude * weight;
            });

            return {
                latitude: weightedLatSum / totalWeight,
                longitude: weightedLngSum / totalWeight
            };
        }

        // Function to simulate getting WLAN signal strength
        function getWLANSignalStrength() {
            return Math.floor(Math.random() * 100) + 1; // Random number between 1 and 100
        }

        // Function to simulate getting Cellular signal strength
        function getCellularSignalStrength() {
            return Math.floor(Math.random() * 100) + 1; // Random number between 1 and 100
        }
    </script>
</body>
</html>
