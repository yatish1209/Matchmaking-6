<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Location</title>
    <link href="styles.css" rel="stylesheet">
    <style>
        #map-container {
            position: relative;
            width: 500px; /* adjust as needed */
            height: 500px; /* adjust as needed */
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Get Location</h1>
        <p>Tap the button below to get the location</p>
        <button class="get-location-btn" onclick="collectAndMatchData()">Get Location</button>
        <div id="output"></div>
        <div id="map-container">
            <img id="map" src="Floor Plan 1000x1000 px.jpg" alt="Map">
            <div id="marker"></div>
        </div>
    </div>

    <script>
        async function collectAndMatchData() {
            // Collect WLAN and Cellular signal strengths
            var wlanStrength = await getWLANSignalStrength();
            var cellularStrength = await getCellularSignalStrength();

            // Fetch the pre-stored values from the table
            fetch('https://sheetdb.io/api/v1/w3rcsxtqatd69')
                .then(response => response.json())
                .then(data => {
                    // Perform interpolation
                    var interpolatedLocation = interpolateLocation(data, wlanStrength, cellularStrength);

                    // Output the collected and matched values
                    var output = document.getElementById('output');
                    output.innerHTML = "<p>Latitude: " + interpolatedLocation.latitude.toFixed(6) + "</p>" +
                                       "<p>Longitude: " + interpolatedLocation.longitude.toFixed(6) + "</p>" +
                                       "<p>WLAN Strength: " + wlanStrength + "</p>" +
                                       "<p>Cellular Strength: " + cellularStrength + "</p>";

                    // Update the marker position
                    var marker = document.getElementById('marker');
                    var map = document.getElementById('map');
                    var markerPositionX = interpolatedLocation.longitude * (map.width / 10);
                    var markerPositionY = map.height - (interpolatedLocation.latitude * (map.height / 10));
                    marker.style.left = markerPositionX + 'px';
                    marker.style.top = markerPositionY + 'px';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('An error occurred while fetching data. Please try again later.');
                });
        }

        function interpolateLocation(data, wlanStrength, cellularStrength) {
            // Use K-Nearest Neighbors (KNN) algorithm
            var k = 3; // Number of nearest neighbors
            var distances = data.map(point => {
                var wlanDifference = Math.abs(wlanStrength - point.data.wlan_strength);
                var cellularDifference = Math.abs(cellularStrength - point.data.cellular_strength);
                var distance = Math.sqrt(Math.pow(wlanDifference, 2) + Math.pow(cellularDifference, 2));
                return { distance, latitude: point.data.latitude, longitude: point.data.longitude };
            });

            // Sort by distance
            distances.sort((a, b) => a.distance - b.distance);

            // Take the average of the top k nearest neighbors
            var nearestNeighbors = distances.slice(0, k);
            var totalLat = 0;
            var totalLng = 0;

            nearestNeighbors.forEach(neighbor => {
                totalLat += neighbor.latitude;
                totalLng += neighbor.longitude;
            });

            return {
                latitude: totalLat / k,
                longitude: totalLng / k
            };
        }

        // Function to get WLAN signal strength using navigator.connection API
        async function getWLANSignalStrength() {
            if (navigator.connection) {
                if (navigator.connection.type === 'wifi') {
                    // There's no direct way to get signal strength, but downlink speed can be a proxy
                    return navigator.connection.downlink || 'Unknown';
                } else {
                    return 'Not connected to WiFi';
                }
            } else {
                return 'Navigator connection API not supported';
            }
        }

        // Function to get Cellular signal strength using navigator.connection API
        async function getCellularSignalStrength() {
            if (navigator.connection) {
                if (navigator.connection.type === 'cellular') {
                    // There's no direct way to get signal strength, but downlink speed can be a proxy
                    return navigator.connection.downlink || 'Unknown';
                } else {
                    return 'Not connected to Cellular';
                }
            } else {
                return 'Navigator connection API not supported';
            }
        }
    </script>
</body>
</html>
