<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Location</title>
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Get Location</h1>
        <p>Tap the button below to get the location</p>
        <button class="get-location-btn" onclick="collectAndMatchData()">Get Location</button>
        <div id="output"></div>
        <div id="map-container">
            <img id="map" src="Floor Plan 1000x1000 px.jpg" alt="Map">
            <div id="marker"></div>
        </div>
    </div>

    <script>
        // Define a constant for the number of nearest neighbors to consider
        const k = 3;

        function collectAndMatchData() {
            // Collect WLAN and Cellular signal strengths
            var wlanStrength = getWLANSignalStrength();
            var cellularStrength = getCellularSignalStrength();

            // Fetch the pre-stored values from the table
            fetch('https://sheetdb.io/api/v1/w3rcsxtqatd69')
                .then(response => response.json())
                .then(data => {
                    // Create an array to store distances and indices
                    var distances = [];

                    // Iterate through each row in the table
                    data.forEach((row, index) => {
                        // Calculate the Euclidean distance between collected values and the values in the table
                        var wlanDifference = Math.abs(wlanStrength - row.wlan_strength);
                        var cellularDifference = Math.abs(cellularStrength - row.cellular_strength);
                        var euclideanDistance = Math.sqrt(Math.pow(wlanDifference, 2) + Math.pow(cellularDifference, 2));

                        // Push the distance and index into the distances array
                        distances.push({ index: index, distance: euclideanDistance });
                    });

                    // Sort the distances array by distance in ascending order
                    distances.sort((a, b) => a.distance - b.distance);

                    // Get the k nearest neighbors
                    var nearestNeighbors = distances.slice(0, k);

                    // Calculate the average of latitude and longitude of k nearest neighbors
                    var avgLatitude = 0;
                    var avgLongitude = 0;
                    nearestNeighbors.forEach(neighbor => {
                        avgLatitude += parseFloat(data[neighbor.index].latitude);
                        avgLongitude += parseFloat(data[neighbor.index].longitude);
                    });
                    avgLatitude /= k;
                    avgLongitude /= k;

                    // Output the collected and matched values
                    var output = document.getElementById('output');
                    output.innerHTML = "<p>Latitude: " + avgLatitude.toFixed(6) + "</p><p>Longitude: " + avgLongitude.toFixed(6) + "</p>" +
                                        "<p>WLAN Strength: " + wlanStrength + "</p><p>Cellular Strength: " + cellularStrength + "</p>";

                    // Update the marker position
                    var marker = document.getElementById('marker');
                    var map = document.getElementById('map');
                    var markerPositionX = avgLongitude * (map.width / 10);
                    var markerPositionY = map.height - (avgLatitude * (map.height / 10));
                    marker.style.left = markerPositionX + 'px';
                    marker.style.top = markerPositionY + 'px';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('An error occurred while fetching data. Please try again later.');
                });
        }

        // Function to simulate getting WLAN signal strength
        function getWLANSignalStrength() {
            if (navigator.connection) {
                // Assuming WLAN if connection type is 'wifi'
                if (navigator.connection.type === 'wifi') {
                    // There's no direct way to get signal strength, but downlink speed can be a proxy
                    return navigator.connection.downlink || 'Unknown';
                } else {
                    return 'Not connected to WiFi';
                }
            } else {
                return 'Navigator connection API not supported';
            }
        }

        // Function to simulate getting Cellular signal strength
        function getCellularSignalStrength() {
                // Assuming cellular if connection type is 'cellular'
                if (navigator.connection.type === 'cellular') {
                    // There's no direct way to get signal strength, but downlink speed can be a proxy
                    return navigator.connection.downlink || 'Unknown';
                } else {
                    return 'Not connected to Cellular';
                }
            } else {
                return 'Navigator connection API not supported';
            }
    </script>
</body>
</html>
